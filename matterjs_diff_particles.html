<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.12.0/matter.min.js"></script> -->
    <script src="JS/matter.js"></script>
    <script src="JS/Particle.js"></script>
    <script src="JS/Windmill.js"></script>
    <script src="JS/Wheel.js"></script>
    <script src="JS/ConveyorBelt.js"></script>
    <title>Document</title>
  </head>
  <body>
    <svg width="500" height="500" viewBox="0 0 1000 1000">
      <defs>
        <g id="gear">
          <g transform="translate(-50 -50)">
            <path
              d="M71.2146 14.7854L69.0933 12.664L69.0933 12.664L71.2146 14.7854ZM85.3568 14.7854L83.2355 16.9067L83.2355 16.9067L85.3568 14.7854ZM85.3568 28.9275L87.4781 31.0488L87.4781 31.0488L85.3568 28.9275ZM14.6461 85.496L16.7674 83.3747L16.7674 83.3747L14.6461 85.496ZM14.6461 71.3539L12.5248 69.2326L12.5248 69.2326L14.6461 71.3539ZM14.7854 28.7854L12.664 30.9067L12.664 30.9067L14.7854 28.7854ZM14.7854 14.6432L16.9067 16.7645L16.9067 16.7645L14.7854 14.6432ZM32.1575 15.7946L33.5472 18.4533L32.1575 15.7946ZM15.8875 31.9809L13.236 30.5775L15.8875 31.9809ZM13.1641 38.5255L16.0286 39.4168L13.1641 38.5255ZM13.1641 61.4745L10.2996 62.3658L13.1641 61.4745ZM15.546 70.454L13.4247 68.3326L15.546 70.454ZM15.8875 68.0191L18.5389 66.6156L15.8875 68.0191ZM38.5255 86.8359L37.6342 89.7005L38.5255 86.8359ZM68.0191 84.1125L66.6156 81.4611L68.0191 84.1125ZM86.8359 38.5255L83.9714 39.4169L86.8359 38.5255ZM68.0191 15.8875L69.4225 13.236L68.0191 15.8875ZM70.454 15.546L72.5753 17.6674L70.454 15.546ZM32.1575 84.2054L30.7678 86.8641L32.1575 84.2054ZM86.8359 61.4745L83.9714 60.5831L83.9714 60.5831L86.8359 61.4745ZM61.4745 86.8359L60.5831 83.9714L61.4745 86.8359ZM84.552 29.7322L82.4307 27.6109L84.552 29.7322ZM84.2054 32.1575L81.5467 33.5472L84.2054 32.1575ZM84.2054 67.8425L86.8641 69.2322L84.2054 67.8425ZM50 -3C42.8203 -3 37 2.8203 37 10H43C43 6.13401 46.134 3 50 3V-3ZM63 10C63 2.8203 57.1797 -3 50 -3V3C53.866 3 57 6.13401 57 10H63ZM63 11.2025V10H57V11.2025H63ZM69.4225 13.236C67.1842 12.0512 64.8241 11.0645 62.3658 10.2996L60.5832 16.0286C62.6838 16.6822 64.7012 17.5256 66.6156 18.5389L69.4225 13.236ZM69.0933 12.664L68.3326 13.4247L72.5753 17.6674L73.336 16.9067L69.0933 12.664ZM87.4781 12.664C82.4013 7.58722 74.1701 7.58722 69.0933 12.664L73.336 16.9067C76.0696 14.173 80.5018 14.173 83.2355 16.9067L87.4781 12.664ZM87.4781 31.0488C92.5549 25.972 92.5549 17.7408 87.4781 12.664L83.2355 16.9067C85.9691 19.6403 85.9691 24.0725 83.2355 26.8062L87.4781 31.0488ZM86.6733 31.8536L87.4781 31.0488L83.2355 26.8062L82.4307 27.6109L86.6733 31.8536ZM89.7005 37.6342C88.9572 35.2455 88.0045 32.9495 86.8641 30.7678L81.5467 33.5472C82.522 35.413 83.3363 37.3757 83.9714 39.4169L89.7005 37.6342ZM90 37H88.7975V43H90V37ZM103 50C103 42.8203 97.1797 37 90 37V43C93.866 43 97 46.134 97 50H103ZM90 63C97.1797 63 103 57.1797 103 50H97C97 53.866 93.866 57 90 57V63ZM88.7975 63H90V57H88.7975V63ZM86.8641 69.2322C88.0045 67.0505 88.9572 64.7545 89.7005 62.3658L83.9714 60.5831C83.3363 62.6243 82.522 64.587 81.5467 66.4528L86.8641 69.2322ZM87.6173 69.0904L86.6733 68.1464L82.4307 72.3891L83.3747 73.3331L87.6173 69.0904ZM87.6174 87.4752C92.6942 82.3984 92.6942 74.1672 87.6173 69.0904L83.3747 73.3331C86.1084 76.0667 86.1084 80.4989 83.3747 83.2326L87.6174 87.4752ZM69.2326 87.4752C74.3094 92.552 82.5405 92.552 87.6174 87.4752L83.3747 83.2326C80.641 85.9662 76.2089 85.9662 73.4752 83.2326L69.2326 87.4752ZM68.3326 86.5753L69.2326 87.4752L73.4752 83.2326L72.5753 82.3326L68.3326 86.5753ZM62.3658 89.7005C64.8241 88.9355 67.1842 87.9488 69.4225 86.764L66.6156 81.4611C64.7012 82.4744 62.6838 83.3178 60.5831 83.9714L62.3658 89.7005ZM63 90V88.7975H57V90H63ZM50 103C57.1797 103 63 97.1797 63 90H57C57 93.866 53.866 97 50 97V103ZM37 90C37 97.1797 42.8203 103 50 103V97C46.134 97 43 93.866 43 90H37ZM37 88.7975V90H43V88.7975H37ZM30.7678 86.8641C32.9495 88.0045 35.2455 88.9572 37.6342 89.7005L39.4169 83.9714C37.3757 83.3363 35.413 82.522 33.5472 81.5467L30.7678 86.8641ZM30.9096 87.6173L31.8536 86.6733L27.6109 82.4307L26.6669 83.3747L30.9096 87.6173ZM12.5248 87.6174C17.6016 92.6942 25.8327 92.6942 30.9096 87.6173L26.6669 83.3747C23.9332 86.1084 19.5011 86.1084 16.7674 83.3747L12.5248 87.6174ZM12.5248 69.2326C7.44797 74.3094 7.44797 82.5405 12.5248 87.6174L16.7674 83.3747C14.0338 80.641 14.0338 76.2089 16.7674 73.4752L12.5248 69.2326ZM13.4247 68.3326L12.5248 69.2326L16.7674 73.4752L17.6674 72.5753L13.4247 68.3326ZM10.2996 62.3658C11.0645 64.8241 12.0512 67.1842 13.236 69.4225L18.5389 66.6156C17.5256 64.7012 16.6822 62.6838 16.0286 60.5831L10.2996 62.3658ZM10 63H11.2025V57H10V63ZM-3 50C-3 57.1797 2.8203 63 10 63V57C6.13401 57 3 53.866 3 50H-3ZM10 37C2.8203 37 -3 42.8203 -3 50H3C3 46.134 6.13401 43 10 43V37ZM11.2025 37H10V43H11.2025V37ZM13.236 30.5775C12.0512 32.8158 11.0645 35.1759 10.2996 37.6341L16.0286 39.4168C16.6822 37.3162 17.5256 35.2988 18.5389 33.3844L13.236 30.5775ZM12.664 30.9067L13.4247 31.6674L17.6674 27.4247L16.9067 26.664L12.664 30.9067ZM12.664 12.5219C7.58722 17.5987 7.58722 25.8299 12.664 30.9067L16.9067 26.664C14.173 23.9304 14.173 19.4982 16.9067 16.7645L12.664 12.5219ZM31.0488 12.5219C25.972 7.44508 17.7408 7.44508 12.664 12.5219L16.9067 16.7645C19.6403 14.0309 24.0725 14.0309 26.8062 16.7645L31.0488 12.5219ZM31.8536 13.3267L31.0488 12.5219L26.8062 16.7645L27.6109 17.5693L31.8536 13.3267ZM37.6342 10.2996C35.2455 11.0428 32.9495 11.9955 30.7678 13.1359L33.5472 18.4533C35.4131 17.478 37.3757 16.6637 39.4169 16.0286L37.6342 10.2996ZM37 10V11.2025H43V10H37ZM61.2857 50C61.2857 56.2329 56.2329 61.2857 50 61.2857V67.2857C59.5466 67.2857 67.2857 59.5466 67.2857 50H61.2857ZM50 38.7143C56.2329 38.7143 61.2857 43.7671 61.2857 50H67.2857C67.2857 40.4534 59.5466 32.7143 50 32.7143V38.7143ZM38.7143 50C38.7143 43.7671 43.7671 38.7143 50 38.7143V32.7143C40.4534 32.7143 32.7143 40.4534 32.7143 50H38.7143ZM50 61.2857C43.7671 61.2857 38.7143 56.2329 38.7143 50H32.7143C32.7143 59.5466 40.4534 67.2857 50 67.2857V61.2857ZM39.4169 16.0286C41.4674 15.3905 43 13.4914 43 11.2025H37C37 10.7243 37.3127 10.3996 37.6342 10.2996L39.4169 16.0286ZM27.6109 17.5693C29.2261 19.1845 31.6471 19.4465 33.5472 18.4533L30.7678 13.1359C31.0663 12.9798 31.5163 12.9894 31.8536 13.3267L27.6109 17.5693ZM18.5389 33.3844C19.5463 31.4813 19.2898 29.0471 17.6674 27.4247L13.4247 31.6674C13.0859 31.3285 13.0778 30.8763 13.236 30.5775L18.5389 33.3844ZM11.2025 43C13.4914 43 15.3906 41.4673 16.0286 39.4168L10.2996 37.6341C10.3996 37.3127 10.7243 37 11.2025 37V43ZM16.0286 60.5831C15.3906 58.5327 13.4914 57 11.2025 57V63C10.7243 63 10.3996 62.6873 10.2996 62.3658L16.0286 60.5831ZM17.6674 72.5753C19.2898 70.9529 19.5463 68.5187 18.5389 66.6156L13.236 69.4225C13.0778 69.1237 13.0859 68.6715 13.4247 68.3326L17.6674 72.5753ZM43 88.7975C43 86.5086 41.4674 84.6095 39.4169 83.9714L37.6342 89.7005C37.3127 89.6004 37 89.2757 37 88.7975H43ZM72.5753 82.3326C70.9529 80.7102 68.5187 80.4537 66.6156 81.4611L69.4225 86.764C69.1237 86.9222 68.6715 86.9141 68.3326 86.5753L72.5753 82.3326ZM83.9714 39.4169C84.6095 41.4674 86.5086 43 88.7975 43V37C89.2757 37 89.6004 37.3127 89.7005 37.6342L83.9714 39.4169ZM66.6156 18.5389C68.5187 19.5463 70.9529 19.2898 72.5753 17.6674L68.3326 13.4247C68.6715 13.0859 69.1237 13.0778 69.4225 13.236L66.6156 18.5389ZM33.5472 81.5467C31.6471 80.5535 29.2261 80.8155 27.6109 82.4307L31.8536 86.6733C31.5163 87.0106 31.0663 87.0202 30.7678 86.8641L33.5472 81.5467ZM88.7975 57C86.5086 57 84.6095 58.5326 83.9714 60.5831L89.7005 62.3658C89.6004 62.6873 89.2757 63 88.7975 63V57ZM60.5831 83.9714C58.5327 84.6095 57 86.5086 57 88.7975H63C63 89.2757 62.6873 89.6004 62.3658 89.7005L60.5831 83.9714ZM82.4307 27.6109C80.8155 29.2261 80.5535 31.6471 81.5467 33.5472L86.8641 30.7678C87.0202 31.0663 87.0106 31.5163 86.6733 31.8536L82.4307 27.6109ZM81.5467 66.4528C80.5535 68.3529 80.8155 70.7739 82.4307 72.3891L86.6733 68.1464C87.0106 68.4837 87.0202 68.9337 86.8641 69.2322L81.5467 66.4528ZM57 11.2025C57 13.4914 58.5327 15.3906 60.5832 16.0286L62.3658 10.2996C62.6873 10.3996 63 10.7243 63 11.2025H57Z"
              fill="#D9D9D9"
              mask="url(#path-1-inside-1_1513_1120)"
            />
          </g>
        </g>
      </defs>
      <rect x="0" y="0" width="1000" height="1000" fill="#212121" />
      <g id="holder"></g>
    </svg>
    <input
      id="spinSlider"
      type="range"
      min="-1"
      max="1"
      step="0.01"
      value="0"
    />
  </body>
  <script>
    const { Engine, Render, Runner, Bodies, Composite, World } = Matter;
    let w = 1000;
    let h = 1000;

    const engine = Engine.create();
    const holder = document.querySelector("#holder");
    const balls = [];
    const ballGraphics = [];
    const windmills = [];
    const windmillGraphics = [];
    const wheels = [];
    const wheelGraphics = [];

    let conveyor = null;
    let conveyorGraphic = null;

    const num = 200;
    const maxRadius = 3;
    const wmbladeWidth = 600;
    let spinSpeed = 0;
    const spinSlider = document.querySelector("#spinSlider");

    const initSlider = () => {
      spinSlider.addEventListener("input", (e) => {
        const val = e.target.value;
        spinSpeed = parseFloat(val) / 20;
      });
    };

    const makeParticles = () => {
      for (let i = 0; i < num; i++) {
        const radius = 5 + Math.round(Math.random() * maxRadius);
        const xpos = 500 + (Math.random() * 100 - 50);
        const ypos = i * -radius;
        const type = Math.random() > 0.5 ? "circle" : "rect";

        const b =
          type == "circle"
            ? getCircBody(xpos, ypos, radius, i)
            : getRectBody(xpos, ypos, radius, i);
        const p = new Particle(xpos, ypos, radius, b, type);
        p.init(holder);
        balls.push(b);
        ballGraphics.push(p);
      }
    };

    const getCircBody = (xpos, ypos, radius, index, static = false) => {
      const b = Bodies.circle(xpos, ypos, radius, {
        id: `ball_${index}`,
        friction: 1,
        restitution: 0.6,
        isStatic: static,
        frictionStatic: 1,
      });

      return b;
    };

    const getRectBody = (xpos, ypos, radius, index, static = false) => {
      const b = Bodies.rectangle(xpos, ypos, radius * 2, radius * 2, {
        id: `ball_${index}`,
        friction: 1,
        restitution: 0.6,
        isStatic: static,
        frictionStatic: 1,
      });

      return b;
    };

    const leftwall = Bodies.rectangle(-50, 500, 100, 1000, {
      isStatic: true,
      id: "leftwall",
    });

    const rightwall = Bodies.rectangle(1050, 500, 100, 1000, {
      isStatic: true,
      id: "righttwall",
    });

    const makeWindmills = () => {
      buildWindmill(300, 300, 400, 15);
      buildWindmill(700, 300, 400, 15);
    };

    const buildWindmill = (xpos, ypos, bladeWidth, bladeThickness) => {
      const h = Bodies.rectangle(0, 0, bladeWidth, bladeThickness, {
        id: `horiz_blade`,
        friction: 1,
        restitution: 1,
        isStatic: true,
        // frictionStatic: 10,
      });

      const v = Bodies.rectangle(0, 0, bladeThickness, bladeWidth, {
        id: `vert_blade`,
        friction: 1,
        restitution: 1,
        isStatic: true,
        // frictionStatic: 10,
      });

      const b = Matter.Body.create({
        id: `b`,
        friction: 0,
        restitution: 1,
        isStatic: true,
        // frictionStatic: 10,
      });
      Matter.Body.setParts(b, [h, v]);
      Matter.Body.setPosition(b, { x: xpos, y: ypos });

      windmills.push(b);
      const wm = new Windmill(xpos, ypos, bladeWidth, bladeThickness, b); //new Windmill(500, 500, bladeWidth,);
      wm.init(holder);
      windmillGraphics.push(wm);
    };

    const makeWheels = () => {
      buildWheel(500, 600, 100);
    };

    const buildWheel = (xpos, ypos, r) => {
      const b = getCircBody(xpos, ypos, r, 123, true);
      wheels.push(b);

      const w = new Wheel(xpos, ypos, r, b);
      w.init(holder);
      wheelGraphics.push(w);
    };

    const makeConveyor = (xpos, ypos, w) => {
      conveyor = Bodies.rectangle(xpos, ypos, w, 50, {
        id: `conveyor`,
        friction: 1,
        restitution: 0.6,
        isStatic: true,
        frictionStatic: 1,
      });

      conveyorGraphic = new ConveyorBelt(xpos, ypos, w, 50, conveyor);
      conveyorGraphic.init(holder);
    };

    const update = () => {
      balls.forEach((ball) => {
        if (ball.position.y > 1100) {
          Matter.Body.setPosition(ball, { x: 400 + Math.random() * 200, y: 0 });
          Matter.Body.setSpeed(ball, 0);
        }
      });

      ballGraphics.forEach((particle) => {
        particle.update();
      });

      windmills.forEach((windmill, index) => {
        //const speed = 0.1;
        const rot = index % 2 == 0 ? spinSpeed : -spinSpeed;
        const angle = windmill.angle;
        const pos = windmill.position;
        Matter.Body.rotate(windmill, rot, pos, true);
        //Matter.Body.setPosition(windmill, { x: pos.x + speed, y: pos.y });
        //Matter.Body.setVelocity(windmill, { x: speed, y: 0 });
      });

      windmillGraphics.forEach((windmill) => {
        windmill.update();
      });

      wheels.forEach((wheel) => {
        const pos = wheel.position;
        Matter.Body.rotate(wheel, 0.01, pos, true);
      });

      wheelGraphics.forEach((wheelGraphic) => {
        wheelGraphic.update();
      });

      conveyorGraphic.update();
      window.requestAnimationFrame(update);
    };

    const initWorld = () => {
      let runner = Runner.create();
      World.add(engine.world, [...balls, ...windmills, ...wheels, conveyor]);
      Runner.run(runner, engine);
    };

    initSlider();
    makeParticles();
    makeWindmills();

    makeWheels();
    makeConveyor(500, 800, 800);
    initWorld();

    update();
  </script>
</html>
